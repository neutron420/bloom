// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String   @id @default(cuid())
  name           String
  email          String?  @unique
  password       String?  // Hashed password for authentication
  googleId       String?  @unique // Google OAuth ID
  profilePicture String?  // Profile picture URL
  isAdmin        Boolean  @default(false) // Admin access flag
  adminAssignedAt DateTime? // When admin status was assigned
  adminAssignedBy String?  // ID of admin who assigned this role (self-reference)
  suspended      Boolean  @default(false) // User suspension flag
  suspendedAt    DateTime? // When user was suspended
  suspendedBy    String?  // Admin ID who suspended
  suspensionReason String? // Reason for suspension
  flagged       Boolean  @default(false) // User flagged for review
  flaggedAt     DateTime? // When user was flagged
  flaggedBy     String?  // Admin ID who flagged
  flagReason    String?  // Reason for flagging
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  meetings      MeetingParticipant[]
  joinRequests  JoinRequest[]
  chatMessages  ChatMessage[]
  screenShares  ScreenShare[]
  
  @@index([name])
  @@index([email])
  @@index([isAdmin])
  @@index([suspended])
  @@index([flagged])
  @@map("users")
}

enum AdminRole {
  MAIN_ADMIN
  SUPER_ADMIN
}

model Admin {
  id        String    @id @default(cuid())
  name      String
  email     String    @unique
  password  String    // Hashed password for authentication
  role      AdminRole @default(SUPER_ADMIN) // MAIN_ADMIN or SUPER_ADMIN
  isActive  Boolean   @default(true) // Can be deactivated by main admin
  createdBy String?   // ID of main admin who created this admin
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("admins")
}

model Meeting {
  id              String   @id @default(cuid())
  roomId          String   @unique
  title           String?
  requiresApproval Boolean @default(false) // Whether meeting requires approval to join
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  participants MeetingParticipant[]
  joinRequests JoinRequest[]
  chatMessages ChatMessage[]
  screenShares ScreenShare[]
  
  @@map("meetings")
}

model MeetingParticipant {
  id        String   @id @default(cuid())
  userId    String
  meetingId String
  joinedAt  DateTime @default(now())
  leftAt    DateTime?
  isHost    Boolean  @default(false) // Host/admin of the meeting
  
  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  @@unique([userId, meetingId])
  @@index([meetingId, leftAt]) // Optimize queries for active participants
  @@index([userId])
  @@index([meetingId, isHost]) // Optimize host queries
  @@map("meeting_participants")
}

enum JoinRequestStatus {
  pending
  approved
  declined
}

model JoinRequest {
  id          String            @id @default(cuid())
  userId      String
  meetingId   String
  name        String
  email       String?
  status      JoinRequestStatus @default(pending)
  requestedAt DateTime          @default(now())
  respondedAt DateTime?
  
  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  @@unique([userId, meetingId])
  @@index([meetingId, status]) // Optimize queries for pending requests
  @@index([userId])
  @@map("join_requests")
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  meetingId String
  message   String
  createdAt DateTime @default(now())
  
  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  @@index([meetingId, createdAt]) // Optimize queries for chat history
  @@index([userId])
  @@map("chat_messages")
}

model ScreenShare {
  id        String   @id @default(cuid())
  userId    String
  meetingId String
  startedAt DateTime @default(now())
  stoppedAt DateTime?
  isActive  Boolean  @default(true) // Whether screen sharing is currently active
  
  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  @@index([meetingId, isActive]) // Optimize queries for active screen shares
  @@index([userId])
  @@map("screen_shares")
}

model AdminActivityLog {
  id        String   @id @default(cuid())
  adminId   String   // Admin who performed action
  action    String   // Action type (e.g., "user_deleted", "meeting_ended")
  targetType String? // Type of target (user, meeting, etc.)
  targetId  String? // ID of target
  details   String?  // JSON string for additional details
  ipAddress String?
  createdAt DateTime @default(now())
  
  @@index([adminId])
  @@index([createdAt])
  @@index([action])
  @@map("admin_activity_logs")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String?
  ipAddress String
  success   Boolean
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
  @@index([success])
  @@map("login_attempts")
}

model BlockedIP {
  id        String   @id @default(cuid())
  ipAddress String   @unique
  reason    String?
  expiresAt DateTime?
  blockedBy String?  // Admin ID
  createdAt DateTime @default(now())
  
  @@index([ipAddress])
  @@index([expiresAt])
  @@map("blocked_ips")
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   // JSON string for complex values
  updatedAt DateTime @updatedAt
  updatedBy String?  // Admin ID
  
  @@map("system_settings")
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  message   String
  targetType String  @default("all") // all, specific_users
  targetUserIds String? // JSON array of user IDs if targetType is specific_users
  createdBy String   // Admin ID
  createdAt DateTime @default(now())
  expiresAt DateTime?
  isActive  Boolean  @default(true)
  
  @@index([isActive])
  @@index([createdAt])
  @@map("announcements")
}

